USE [TP3]
GO
/****** Object:  StoredProcedure [dbo].[SP_ProcesarPropiedades]    Script Date: 25/11/2025 3:47:25 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER   PROCEDURE [dbo].[SP_ProcesarPropiedades]
    @inXmlFecha XML
    , @outResultCode INT OUTPUT
AS
BEGIN
    SET NOCOUNT ON;
    
    BEGIN TRY

        IF @inXmlFecha.exist('/FechaOperacion/Propiedades/Propiedad') = 0
        BEGIN
            SET @outResultCode = 0;
            RETURN;
        END;

        INSERT INTO dbo.Propiedad (
            NumeroFinca
            , NumeroMedidor
            , MetrosCuadrados
            , TipoUsoId
            , TipoZonaId
            , ValorFiscal
            , FechaRegistro
        )
        SELECT 
            Propiedad.value('@numeroFinca', 'VARCHAR(20)')
            , Propiedad.value('@numeroMedidor', 'VARCHAR(20)')
            , Propiedad.value('@metrosCuadrados', 'DECIMAL(10,2)')
            , Propiedad.value('@tipoUsoId', 'INT')
            , Propiedad.value('@tipoZonaId', 'INT')
            , Propiedad.value('@valorFiscal', 'DECIMAL(15,2)')
            , Propiedad.value('@fechaRegistro', 'DATE')
        FROM @inXmlFecha.nodes('/FechaOperacion/Propiedades/Propiedad') AS Propiedades(Propiedad);
        
        SET @outResultCode = 0;
    END TRY

    BEGIN CATCH
        SET @outResultCode = 50008;

        INSERT INTO dbo.DBError (
            UserName
            , Number
            , State
            , Severity
            , Line
            , [Procedure]
            , Message
            , DateTime
        )
        VALUES (
            'SP_ProcesarPropiedades'
            , ERROR_NUMBER()
            , ERROR_STATE()
            , ERROR_SEVERITY()
            , ERROR_LINE()
            , 'SP_ProcesarPropiedades'
            , ERROR_MESSAGE()
            , GETDATE()
        );
    END CATCH;
END;